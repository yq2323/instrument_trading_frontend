<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 校园二手乐器交易平台</title>
    
    <!-- CSS样式 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        /* 个人中心特有样式 */
        .user-container {
            padding: 40px 0;
            min-height: 80vh;
        }
        
        .user-sidebar {
            position: sticky;
            top: 100px;
        }
        
        .user-profile-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            border: 3px solid #667eea;
        }
        
        .user-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .user-email {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .user-credit {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 20px;
            display: inline-block;
            color: #f39c12;
            font-weight: 500;
        }
        
        .user-menu {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .menu-item {
            display: block;
            padding: 15px 20px;
            color: #555;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-item:hover {
            background: #f8f9fa;
            color: #667eea;
            border-left-color: #667eea;
        }
        
        .menu-item.active {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-left-color: #667eea;
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .user-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 30px;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .content-header h2 {
            font-size: 24px;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 资料编辑样式 */
        .profile-form .form-group {
            margin-bottom: 25px;
        }
        
        .profile-form label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .profile-form .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .profile-form .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-actions {
            flex: 1;
        }
        
        .avatar-actions input[type="file"] {
            display: none;
        }
        
        /* 乐器列表样式 */
        .instruments-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .instrument-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }
        
        .instrument-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .instrument-image {
            height: 160px;
            overflow: hidden;
            position: relative;
        }
        
        .instrument-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .instrument-card:hover .instrument-image img {
            transform: scale(1.05);
        }
        
        .instrument-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-available {
            background: #2ecc71;
            color: white;
        }
        
        .status-pending {
            background: #f39c12;
            color: white;
        }
        
        .status-sold {
            background: #e74c3c;
            color: white;
        }
        
        .status-removed {
            background: #95a5a6;
            color: white;
        }
        
        .instrument-info {
            padding: 15px;
        }
        
        .instrument-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 40px;
        }
        
        .instrument-price {
            color: #e74c3c;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .instrument-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .instrument-actions .btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        /* 订单列表样式 */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .order-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .order-id {
            font-weight: 600;
            color: #333;
        }
        
        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .order-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .order-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .order-item img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .order-item-info {
            flex: 1;
        }
        
        .order-item-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .order-item-price {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .order-total {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }
        
        /* 收藏列表样式 */
        .favorites-empty {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .favorites-empty i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .user-sidebar {
                margin-bottom: 30px;
            }
            
            .instruments-list {
                grid-template-columns: 1fr;
            }
            
            .order-info {
                grid-template-columns: 1fr;
            }
            
            .order-footer {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">
                <i class="fas fa-guitar"></i>
                <span>校园乐器汇</span>
            </a>
            
            <div class="nav-menu">
                <a href="index.html">
                    <i class="fas fa-home"></i> 首页
                </a>
                <a href="publish.html">
                    <i class="fas fa-plus-circle"></i> 发布
                </a>
                <a href="cart.html" id="cartLink">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span> 购物车
                </a>
                <a href="user.html" class="active">
                    <i class="fas fa-user"></i> 个人中心
                </a>
                
                <div class="user-dropdown">
                    <button class="user-btn" id="userBtn">
                        <i class="fas fa-user"></i>
                        <span id="username">未登录</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="userMenu">
                        <a href="user.html">
                            <i class="fas fa-user-circle"></i> 个人中心
                        </a>
                        <a href="user.html#favorites">
                            <i class="fas fa-heart"></i> 我的收藏
                        </a>
                        <div class="divider"></div>
                        <a href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> 退出登录
                        </a>
                    </div>
                </div>
                
                <div class="auth-buttons" id="authButtons">
                    <a href="login.html" class="btn btn-outline">登录</a>
                    <a href="register.html" class="btn btn-primary">注册</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 个人中心内容 -->
    <main class="user-container">
        <div class="container">
            <div class="row" style="display: grid; grid-template-columns: 250px 1fr; gap: 30px;">
                <!-- 侧边栏 -->
                <div class="user-sidebar">
                    <div class="user-profile-card" id="userProfileCard">
                        <!-- 用户信息将通过JS动态加载 -->
                        <div class="loading">加载中...</div>
                    </div>
                    
                    <div class="user-menu">
                        <a href="#profile" class="menu-item active" onclick="showSection('profile')">
                            <i class="fas fa-user-edit"></i>
                            <span>个人资料</span>
                        </a>
                        <a href="#my-instruments" class="menu-item" onclick="showSection('my-instruments')">
                            <i class="fas fa-music"></i>
                            <span>我的发布</span>
                        </a>
                        <a href="#favorites" class="menu-item" onclick="showSection('favorites')">
                            <i class="fas fa-heart"></i>
                            <span>我的收藏</span>
                        </a>
                        <a href="#orders" class="menu-item" onclick="showSection('orders')">
                            <i class="fas fa-file-alt"></i>
                            <span>我的订单</span>
                        </a>
                        <a href="#settings" class="menu-item" onclick="showSection('settings')">
                            <i class="fas fa-cog"></i>
                            <span>账户设置</span>
                        </a>
                    </div>
                </div>
                
                <!-- 主内容区 -->
                <div class="user-content">
                    <!-- 个人资料 -->
                    <div id="profile-section" class="content-section active">
                        <div class="content-header">
                            <h2><i class="fas fa-user-edit"></i> 个人资料</h2>
                        </div>
                        
                        <form id="profileForm" enctype="multipart/form-data">
                            <div class="avatar-upload">
                                <div class="avatar-preview">
                                    <img id="avatarPreview" src="images/default-avatar.svg" alt="头像预览">
                                </div>
                                <div class="avatar-actions">
                                    <label class="btn btn-outline">
                                        <i class="fas fa-camera"></i> 更换头像
                                        <input type="file" id="avatar" name="avatar" accept="image/jpeg,image/png" style="display: none;">
                                    </label>
                                    <button type="button" class="btn btn-outline" id="removeAvatarBtn" style="margin-top: 10px;">
                                        <i class="fas fa-trash"></i> 移除头像
                                    </button>
                                    <p class="hint">支持 JPG、PNG 格式，建议尺寸 200x200px，文件大小不超过2MB</p>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>用户名</label>
                                    <input type="text" class="form-control" id="profileUsername" readonly>
                                </div>
                                <div class="form-group">
                                    <label>邮箱</label>
                                    <input type="email" class="form-control" id="profileEmail" readonly>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>真实姓名</label>
                                    <input type="text" class="form-control" id="real_name" name="real_name">
                                </div>
                                <div class="form-group">
                                    <label>手机号</label>
                                    <input type="tel" class="form-control" id="phone" name="phone">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>学号</label>
                                    <input type="text" class="form-control" id="student_id" name="student_id">
                                </div>
                                <div class="form-group">
                                    <label>学校</label>
                                    <input type="text" class="form-control" id="school" name="school">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>个人简介</label>
                                <textarea class="form-control" id="bio" name="bio" rows="3" placeholder="介绍一下自己..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 保存修改
                            </button>
                        </form>
                    </div>
                    
                    <!-- 我的发布 -->
                    <div id="my-instruments-section" class="content-section" style="display: none;">
                        <div class="content-header">
                            <h2><i class="fas fa-music"></i> 我的发布</h2>
                            <a href="publish.html" class="btn btn-primary">
                                <i class="fas fa-plus"></i> 发布新乐器
                            </a>
                        </div>
                        
                        <div class="instruments-list" id="myInstrumentsList">
                            <!-- 我的发布将通过JS动态加载 -->
                            <div class="loading">加载中...</div>
                        </div>
                    </div>
                    
                    <!-- 我的收藏 -->
                    <div id="favorites-section" class="content-section" style="display: none;">
                        <div class="content-header">
                            <h2><i class="fas fa-heart"></i> 我的收藏</h2>
                        </div>
                        
                        <div class="instruments-list" id="favoritesList">
                            <!-- 收藏列表将通过JS动态加载 -->
                            <div class="loading">加载中...</div>
                        </div>
                    </div>
                    
                    <!-- 我的订单 -->
                    <div id="orders-section" class="content-section" style="display: none;">
                        <div class="content-header">
                            <h2><i class="fas fa-file-alt"></i> 我的订单</h2>
                        </div>
                        
                        <div class="orders-list" id="ordersList">
                            <!-- 订单列表将通过JS动态加载 -->
                            <div class="loading">加载中...</div>
                        </div>
                    </div>
                    
                    <!-- 账户设置 -->
                    <div id="settings-section" class="content-section" style="display: none;">
                        <div class="content-header">
                            <h2><i class="fas fa-cog"></i> 账户设置</h2>
                        </div>
                        
                        <div class="section-title">
                            <i class="fas fa-lock"></i> 修改密码
                        </div>
                        
                        <form id="passwordForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>当前密码</label>
                                    <input type="password" class="form-control" id="old_password" name="old_password" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>新密码</label>
                                    <input type="password" class="form-control" id="new_password" name="new_password" required>
                                </div>
                                <div class="form-group">
                                    <label>确认新密码</label>
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key"></i> 修改密码
                            </button>
                        </form>
                        
                        <div class="section-title" style="margin-top: 40px;">
                            <i class="fas fa-bell"></i> 通知设置
                        </div>
                        
                        <form id="notificationForm">
                            <div class="form-group">
                                <label class="checkbox">
                                    <input type="checkbox" id="email_notifications" name="email_notifications" checked>
                                    <span>邮件通知</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox">
                                    <input type="checkbox" id="sms_notifications" name="sms_notifications">
                                    <span>短信通知</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox">
                                    <input type="checkbox" id="push_notifications" name="push_notifications" checked>
                                    <span>推送通知</span>
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 保存设置
                            </button>
                        </form>
                        
                        <div class="section-title" style="margin-top: 40px;">
                            <i class="fas fa-exclamation-triangle"></i> 账户安全
                        </div>
                        
                        <div class="danger-zone">
                            <p style="color: #666; margin-bottom: 20px;">删除账户将永久删除所有数据，此操作不可撤销。</p>
                            <button class="btn btn-danger" id="deleteAccountBtn">
                                <i class="fas fa-trash"></i> 删除账户
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>校园乐器汇</h3>
                    <p>专注于校园二手乐器交易，让音乐传递更远</p>
                </div>
                <div class="footer-section">
                    <h4>帮助中心</h4>
                    <ul>
                        <li><a href="#">账户管理</a></li>
                        <li><a href="#">交易指南</a></li>
                        <li><a href="#">常见问题</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>联系我们</h4>
                    <p>课程项目 - 软件工程</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/instrument.js"></script>
    
    <script>
        // 设置API基础URL
        // API基础URL已在config.js中定义
        
        // 当前用户信息
        let currentUser = null;
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            checkAuthStatus();
            
            // 加载用户数据
            loadUserData();
            
            // 绑定事件
            bindEvents();
            
            // 根据URL哈希显示对应部分
            const hash = window.location.hash.substring(1);
            if (hash) {
                showSection(hash);
            }
        });
        
        // 检查登录状态
        async function checkAuthStatus() {
            try {
                const response = await fetch(`${CONFIG.API_BASE}/auth/check_auth`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.authenticated) {
                    // 未登录，跳转到登录页
                    showNotification('请先登录', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                    return false;
                }
                currentUser = data.user;
                return true;
            } catch (error) {
                console.error('检查登录状态失败:', error);
                return false;
            }
        }
        
        // 加载用户数据
        async function loadUserData() {
            const isAuthenticated = await checkAuthStatus();
            if (!isAuthenticated) return;
            
            // 加载用户资料
            loadUserProfile();
            
            // 加载我的发布
            loadMyInstruments();
            
            // 加载我的收藏
            loadFavorites();
            
            // 加载我的订单
            loadOrders();
        }
        
        // 加载用户资料
        async function loadUserProfile() {
            try {
                const response = await fetch(`${CONFIG.API_BASE}/users/profile`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    renderUserProfile(data.user);
                }
            } catch (error) {
                console.error('加载用户资料失败:', error);
            }
        }
        
        // 渲染用户资料
        function renderUserProfile(user) {
            // 更新侧边栏用户卡片
            const userProfileCard = document.getElementById('userProfileCard');
            if (userProfileCard) {
                userProfileCard.innerHTML = `
                    <img src="${user.avatar || 'images/default-avatar.svg'}" 
                         class="user-avatar" 
                         alt="${user.username}"
                         onerror="this.src='images/default-avatar.svg'">
                    <h3 class="user-name">${user.real_name || user.username}</h3>
                    <p class="user-email">${user.email}</p>
                    <div class="user-credit">
                        <i class="fas fa-star"></i> 信用分: ${user.credit_score || 100}
                    </div>
                `;
            }
            
            // 更新资料表单
            document.getElementById('profileUsername').value = user.username;
            document.getElementById('profileEmail').value = user.email;
            document.getElementById('real_name').value = user.real_name || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('student_id').value = user.student_id || '';
            document.getElementById('school').value = user.school || '';
            document.getElementById('bio').value = user.bio || '';
            
            // 更新头像预览
            const avatarPreview = document.getElementById('avatarPreview');
            if (avatarPreview) {
                avatarPreview.src = user.avatar || 'images/default-avatar.svg';
            }
            
            // 重置头像输入
            const avatarInput = document.getElementById('avatar');
            if (avatarInput) {
                avatarInput.value = '';
            }
            
            // 更新导航栏用户名
            const usernameSpan = document.getElementById('username');
            if (usernameSpan) {
                usernameSpan.textContent = user.username;
            }
        }
        
        // 加载我的发布
        async function loadMyInstruments() {
            try {
                const response = await fetch(`${CONFIG.API_BASE}/users/instruments`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.instruments) {
                    renderMyInstruments(data.instruments);
                } else {
                    renderMyInstruments([]);
                }
            } catch (error) {
                console.error('加载我的发布失败:', error);
                renderMyInstruments([]);
            }
        }
        
        // 渲染我的发布
        function renderMyInstruments(instruments) {
            const container = document.getElementById('myInstrumentsList');
            if (!container) return;
            
            if (!instruments || instruments.length === 0) {
                container.innerHTML = `
                    <div class="favorites-empty">
                        <i class="fas fa-music"></i>
                        <h3>暂无发布的乐器</h3>
                        <p>快去发布你的第一个乐器吧！</p>
                        <a href="publish.html" class="btn btn-primary">发布乐器</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = instruments.map(instrument => `
                <div class="instrument-card">
                    <div class="instrument-image">
                        <img src="${instrument.main_image || 'images/default-instrument.jpg'}" 
                             alt="${instrument.title}"
                             onerror="this.src='images/default-instrument.jpg'">
                        <span class="instrument-status status-${instrument.status}">
                            ${getStatusText(instrument.status)}
                        </span>
                    </div>
                    <div class="instrument-info">
                        <h4 class="instrument-title">${instrument.title}</h4>
                        <div class="instrument-price">¥${instrument.price.toFixed(2)}</div>
                        <div class="instrument-meta">
                            <span><i class="fas fa-eye"></i> ${instrument.view_count}</span>
                            <span><i class="fas fa-heart"></i> ${instrument.favorite_count}</span>
                        </div>
                        <div class="instrument-actions">
                            <a href="detail.html?id=${instrument.id}" class="btn btn-outline btn-sm">
                                <i class="fas fa-eye"></i> 查看
                            </a>
                            <a href="publish.html?edit=${instrument.id}" class="btn btn-outline btn-sm">
                                <i class="fas fa-edit"></i> 编辑
                            </a>
                            <button class="btn btn-outline btn-sm" onclick="deleteInstrument(${instrument.id})">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 加载我的收藏
        async function loadFavorites() {
            try {
                const response = await fetch(`${CONFIG.API_BASE}/users/favorites`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.instruments) {
                    renderFavorites(data.instruments);
                } else {
                    renderFavorites([]);
                }
            } catch (error) {
                console.error('加载收藏失败:', error);
                renderFavorites([]);
            }
        }
        
        // 渲染我的收藏
        function renderFavorites(instruments) {
            const container = document.getElementById('favoritesList');
            if (!container) return;
            
            if (!instruments || instruments.length === 0) {
                container.innerHTML = `
                    <div class="favorites-empty">
                        <i class="fas fa-heart"></i>
                        <h3>暂无收藏的乐器</h3>
                        <p>去发现一些好乐器吧！</p>
                        <a href="index.html" class="btn btn-primary">去逛逛</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = instruments.map(instrument => `
                <div class="instrument-card" onclick="window.location.href='detail.html?id=${instrument.id}'">
                    <div class="instrument-image">
                        <img src="${instrument.main_image || 'images/default-instrument.jpg'}" 
                             alt="${instrument.title}"
                             onerror="this.src='images/default-instrument.jpg'">
                        <span class="instrument-status status-${instrument.status}">
                            ${getStatusText(instrument.status)}
                        </span>
                    </div>
                    <div class="instrument-info">
                        <h4 class="instrument-title">${instrument.title}</h4>
                        <div class="instrument-price">¥${instrument.price.toFixed(2)}</div>
                        <div class="instrument-meta">
                            <span><i class="fas fa-eye"></i> ${instrument.view_count}</span>
                            <span><i class="fas fa-heart"></i> ${instrument.favorite_count}</span>
                        </div>
                        <div class="instrument-actions">
                            <button class="btn btn-outline btn-sm" onclick="toggleFavorite(${instrument.id}, event)">
                                <i class="fas fa-heart"></i> 取消收藏
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 加载我的订单
        async function loadOrders() {
            try {
                const response = await fetch(`${CONFIG.API_BASE}/orders`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.orders) {
                    renderOrders(data.orders);
                } else {
                    renderOrders([]);
                }
            } catch (error) {
                console.error('加载订单失败:', error);
                renderOrders([]);
            }
        }
        
        // 渲染我的订单
        function renderOrders(orders) {
            const container = document.getElementById('ordersList');
            if (!container) return;
            
            if (!orders || orders.length === 0) {
                container.innerHTML = `
                    <div class="favorites-empty">
                        <i class="fas fa-file-alt"></i>
                        <h3>暂无订单记录</h3>
                        <p>快去选购心仪的乐器吧！</p>
                        <a href="index.html" class="btn btn-primary">去逛逛</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">订单号: ${order.id}</div>
                        <span class="order-status status-${order.status}">
                            ${getOrderStatusText(order.status)}
                        </span>
                    </div>
                    
                    <div class="order-info">
                        <div class="order-item">
                            <img src="${order.instrument?.main_image || 'images/default-instrument.jpg'}" 
                                 alt="${order.instrument?.title || '商品'}"
                                 onerror="this.src='images/default-instrument.jpg'">
                            <div class="order-item-info">
                                <div class="order-item-title">${order.instrument?.title || '商品已下架'}</div>
                                <div class="order-item-price">¥${order.total_price.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-footer">
                        <div class="order-total">实付: ¥${order.total_price.toFixed(2)}</div>
                        <div class="order-actions">
                            ${order.status === 'pending' ? `
                                <button class="btn btn-primary btn-sm" onclick="payOrder('${order.id}')">
                                    去支付
                                </button>
                            ` : ''}
                            <button class="btn btn-outline btn-sm" onclick="viewOrderDetail('${order.id}')">
                                查看详情
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 绑定事件
        function bindEvents() {
            // 资料表单提交
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', handleProfileUpdate);
            }
            
            // 头像上传
            const avatarInput = document.getElementById('avatar');
            if (avatarInput) {
                avatarInput.addEventListener('change', function(e) {
                    if (this.files.length > 0) {
                        // 验证文件类型
                        const file = this.files[0];
                        const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                        if (!validTypes.includes(file.type)) {
                            showNotification('请上传JPG或PNG格式的图片', 'error');
                            return;
                        }
                        
                        // 验证文件大小
                        if (file.size > 2 * 1024 * 1024) { // 2MB
                            showNotification('图片大小不能超过2MB', 'error');
                            return;
                        }
                        
                        previewAvatar(file);
                    }
                });
            }
            
            // 移除头像按钮
            const removeAvatarBtn = document.getElementById('removeAvatarBtn');
            if (removeAvatarBtn) {
                removeAvatarBtn.addEventListener('click', function() {
                    if (confirm('确定要移除当前头像吗？')) {
                        // 重置头像预览
                        const avatarPreview = document.getElementById('avatarPreview');
                        if (avatarPreview) {
                            avatarPreview.src = 'images/default-avatar.svg';
                        }
                        
                        // 清空文件输入
                        const avatarInput = document.getElementById('avatar');
                        if (avatarInput) {
                            avatarInput.value = '';
                        }
                        
                        // 标记需要移除头像
                        document.getElementById('remove_avatar')?.remove();
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.id = 'remove_avatar';
                        input.name = 'remove_avatar';
                        input.value = 'true';
                        profileForm.appendChild(input);
                    }
                });
            }
            
            // 密码表单提交
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', handlePasswordChange);
            }
            
            // 通知表单提交
            const notificationForm = document.getElementById('notificationForm');
            if (notificationForm) {
                notificationForm.addEventListener('submit', handleNotificationUpdate);
            }
            
            // 删除账户按钮
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', handleDeleteAccount);
            }
        }
        
        // 预览头像
        function previewAvatar(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const avatarPreview = document.getElementById('avatarPreview');
                if (avatarPreview) {
                    avatarPreview.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }
        
        // 处理资料更新
        async function handleProfileUpdate(event) {
            event.preventDefault();
            
            const formData = new FormData();
            
            // 添加文本字段
            const fields = ['real_name', 'phone', 'student_id', 'school', 'bio'];
            fields.forEach(field => {
                const value = document.getElementById(field).value.trim();
                if (value) {
                    formData.append(field, value);
                }
            });
            
            // 添加头像文件
            const avatarInput = document.getElementById('avatar');
            if (avatarInput.files.length > 0) {
                formData.append('avatar', avatarInput.files[0]);
            }
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/auth/update_profile`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('资料更新成功', 'success');
                    
                    // 重新加载用户资料
                    loadUserProfile();
                } else {
                    showNotification(data.message || '更新失败', 'error');
                }
            } catch (error) {
                console.error('更新资料失败:', error);
                showNotification('网络错误，请重试', 'error');
            }
        }
        
        // 处理密码修改
        async function handlePasswordChange(event) {
            event.preventDefault();
            
            const oldPassword = document.getElementById('old_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (!oldPassword || !newPassword || !confirmPassword) {
                showNotification('请填写所有密码字段', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('两次输入的新密码不一致', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('新密码长度至少为6位', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/auth/change_password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('密码修改成功', 'success');
                    
                    // 清空表单
                    event.target.reset();
                } else {
                    showNotification(data.message || '修改失败', 'error');
                }
            } catch (error) {
                console.error('修改密码失败:', error);
                showNotification('网络错误，请重试', 'error');
            }
        }
        
        // 处理通知设置更新
        async function handleNotificationUpdate(event) {
            event.preventDefault();
            
            showNotification('通知设置已保存', 'success');
        }
        
        // 处理删除账户
        function handleDeleteAccount() {
            if (confirm('确定要删除账户吗？此操作不可撤销，所有数据将被永久删除。')) {
                showNotification('删除账户功能正在开发中', 'warning');
            }
        }
        
        // 删除乐器
        async function deleteInstrument(instrumentId) {
            if (!confirm('确定要删除这个乐器吗？此操作不可撤销。')) return;
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/instruments/${instrumentId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('乐器已删除', 'success');
                    
                    // 重新加载我的发布
                    loadMyInstruments();
                } else {
                    showNotification(data.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除乐器失败:', error);
                showNotification('网络错误，请重试', 'error');
            }
        }
        
        // 收藏/取消收藏
        async function toggleFavorite(instrumentId, event) {
            if (event) event.stopPropagation();
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/instruments/${instrumentId}/favorite`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    
                    // 重新加载收藏列表
                    loadFavorites();
                } else {
                    showNotification(data.message || '操作失败', 'error');
                }
            } catch (error) {
                console.error('收藏操作失败:', error);
                showNotification('请先登录', 'error');
            }
        }
        
        // 支付订单
        function payOrder(orderId) {
            showNotification('支付功能正在开发中', 'warning');
        }
        
        // 查看订单详情
        function viewOrderDetail(orderId) {
            showNotification('订单详情功能正在开发中', 'warning');
        }
        
        // 显示对应部分
        function showSection(sectionId) {
            // 隐藏所有部分
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // 移除所有菜单项的active类
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 显示目标部分
            const targetSection = document.getElementById(`${sectionId}-section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // 激活对应的菜单项
            const targetMenuItem = document.querySelector(`.menu-item[href="#${sectionId}"]`);
            if (targetMenuItem) {
                targetMenuItem.classList.add('active');
            }
            
            // 更新URL哈希
            window.location.hash = sectionId;
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'available': '可售',
                'pending': '交易中',
                'sold': '已售出',
                'removed': '已下架'
            };
            return statusMap[status] || status;
        }
        
        // 获取订单状态文本
        function getOrderStatusText(status) {
            const statusMap = {
                'pending': '待支付',
                'paid': '已支付',
                'shipped': '已发货',
                'completed': '已完成',
                'cancelled': '已取消'
            };
            return statusMap[status] || status;
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>